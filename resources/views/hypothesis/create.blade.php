@extends('layouts.app')































































































































@section('title', 'Задать гипотезу')































































































































@push('styles')































































    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">































































    <style>































































        :root {































































            --hypothesis-accent: #e2241b;































































            --hypothesis-accent-dark: #ba1c16;































































            --hypothesis-accent-soft: rgba(226, 36, 27, 0.12);































































        }































































































































        .hypothesis-wrapper {































































            color: #1f1f1f;































































        }































































































































        .hypothesis-wrapper h1 {































































            font-weight: 600;































































            letter-spacing: -0.02em;































































        }































































































































        .hypothesis-card {































































            border: 1px solid rgba(31, 31, 31, 0.08);































































            border-radius: 16px;































































            overflow: hidden;































































        }































































































































        .hypothesis-card .card-body {































































            padding: clamp(1.5rem, 3vw, 2.5rem);































































        }































































































































        .hypothesis-card .form-label {































































            font-weight: 500;































































        }































































































































        .hypothesis-card .form-control,































































        .hypothesis-card .form-select {































































            border-radius: 12px;































































            border-color: rgba(31, 31, 31, 0.12);































































            transition: border-color 0.2s ease, box-shadow 0.2s ease;































































        }































































































































        .hypothesis-card .form-control:focus,































































        .hypothesis-card .form-select:focus {































































            border-color: var(--hypothesis-accent);































































            box-shadow: 0 0 0 0.2rem rgba(226, 36, 27, 0.15);































































        }































































































































        .btn-hypothesis {































































            background-color: var(--hypothesis-accent);































































            border-color: var(--hypothesis-accent);































































            color: #fff;































































            border-radius: 999px;































































            padding-inline: 1.5rem;































































            transition: background-color 0.2s ease, box-shadow 0.2s ease;































































        }































































































































        .btn-hypothesis:hover,































































        .btn-hypothesis:focus {































































            background-color: var(--hypothesis-accent-dark);































































            border-color: var(--hypothesis-accent-dark);































































            color: #fff;































































            box-shadow: 0 0.5rem 1.5rem rgba(226, 36, 27, 0.25);































































        }































































































































        .btn-outline-hypothesis {































































            color: var(--hypothesis-accent);































































            border-color: var(--hypothesis-accent);































































            border-radius: 999px;































































            padding-inline: 1.5rem;































































        }































































































































        .btn-outline-hypothesis:hover,































































        .btn-outline-hypothesis:focus {































































            color: #fff;































































            background-color: var(--hypothesis-accent);































































            border-color: var(--hypothesis-accent);































































            box-shadow: 0 0.5rem 1.5rem rgba(226, 36, 27, 0.18);































































        }































































































































        .input-group .btn-outline-secondary {































































            border-radius: 0 12px 12px 0;































































        }































































































































        .input-group > .form-control {































































            border-radius: 12px 0 0 12px;































































        }































































































































        #locationStatus {































































            display: block;































































            font-size: 0.875rem;































































            margin-top: 0.25rem;































































        }























































        .hypothesis-highlight {































































            background: linear-gradient(180deg, rgba(226, 36, 27, 0.06) 0%, rgba(226, 36, 27, 0.02) 100%);































































            border-radius: 14px;































































            padding: 1rem 1.25rem;































































            border: 1px solid var(--hypothesis-accent-soft);































































        }































































































































        .hypothesis-highlight p {































































            margin-bottom: 0;































































            font-size: 0.95rem;































































            color: rgba(31, 31, 31, 0.72);































































        }































































































































        .hypothesis-option {































































            border: 1px solid rgba(31, 31, 31, 0.12);































































            border-radius: 16px;































































            padding: 1rem 1.25rem;































































            transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;































































            background-color: #fff;































































            cursor: pointer;































































        }































































































































        .hypothesis-option + .hypothesis-option {































































            margin-top: 0.75rem;































































        }































































































































        .hypothesis-option:hover {































































            border-color: var(--hypothesis-accent);































































            box-shadow: 0 0.75rem 1.5rem rgba(226, 36, 27, 0.08);































































            transform: translateY(-2px);































































        }































































































































        .hypothesis-option.active {































































            border-color: var(--hypothesis-accent);































































            box-shadow: 0 0 0 0.2rem rgba(226, 36, 27, 0.12);































































        }































































































































        .hypothesis-option .form-check-input {































































            width: 1.1rem;































































            height: 1.1rem;































































            margin-top: 0.3rem;































































        }































































































































        .hypothesis-option .form-check-input:checked {































































            background-color: var(--hypothesis-accent);































































            border-color: var(--hypothesis-accent);































































        }































































































































        @media (max-width: 576px) {































































            .hypothesis-wrapper h1 {































































                font-size: 1.75rem;































































            }































































































































            .btn-hypothesis,































































            .btn-outline-hypothesis {































































                width: 100%;































































                justify-content: center;































































            }































































































































            .btn-stack {































































                display: flex;































































                flex-direction: column;































































                gap: 0.75rem;































































            }































































































































            .input-group {































































                flex-direction: column;































































            }































































































































            .input-group > .form-control,































































            .input-group .btn {































































                border-radius: 12px;































































            }































































































































            .input-group .btn {































































                margin-top: 0.5rem;































































                width: 100%;































































            }































































        }































































    </style>































































@endpush































































































































@section('content')































































    <div class="container py-4 hypothesis-wrapper">































































        <div class="row justify-content-center">































































            <div class="col-lg-8 col-xl-7">































































                <h1 class="mb-3">Задать гипотезу</h1>































































                <div class="hypothesis-highlight mb-4">































































                    <p>Уточните временной диапазон, выберите категорию, задайте местоположение и сформулируйте гипотезу для проверки.</p>































































                </div>































































                <form action="#" method="post" class="card shadow-sm border-0 hypothesis-card">































































                    <div class="card-body">































































                        <div class="mb-3">































































                            <label for="userLocation" class="form-label">Географическая область</label>































































                            <div class="input-group">



























                                <input type="text" id="userLocation" name="user_location" class="form-control" placeholder="Определяем ваше местоположение..." autocomplete="off">



                                <button type="button" class="btn btn-outline-secondary" id="detectLocationBtn">Определить</button>



                            </div>



                            <small class="text-muted" id="locationStatus">Попробуем автоматически определить город и район.</small>







                        </div>



                        <div class="mb-3">



                            <label for="dateRange" class="form-label">Временной интервал</label>



                            <input type="text" id="dateRange" class="form-control" placeholder="дд.мм.гггг — дд.мм.гггг" autocomplete="off">



                            <div class="form-text">Выберите период, в рамках которого хотите проанализировать данные.</div>







                        </div>















                        <div class="mb-4">







                            <label for="hypothesis" class="form-label">Ваша гипотеза</label>



                            <input type="text" id="hypothesis" class="form-control" placeholder="Опишите, что хотите проверить">











                        </div>







                        <div class="btn-stack d-flex gap-2">



















                            <button type="submit" class="btn btn-hypothesis">































































                                Задать гипотезу































































                            </button>































































                        </div>































































                    </div>































































































































                </form>































































                <div id="hypothesisResult" class="mt-4" hidden>































































                    <div class="card shadow-sm border-0">































































                        <div class="card-header d-flex justify-content-between align-items-center">































































                            <span>Варианты классификации</span>































































                            <span class="badge bg-light text-dark" data-result-status>ожидание</span>































































                        </div>































































                        <div class="card-body" data-result-body>































































                            <p class="text-muted mb-0">Результаты появятся здесь после отправки гипотезы.</p>































































                        </div>































































                        <div class="card-footer d-flex flex-column flex-md-row gap-2 align-items-md-center justify-content-between" data-result-footer hidden>































































                            <span class="text-muted small" data-result-helper>Выберите вариант и проверьте гипотезу.</span>































































                            <button type="button" class="btn btn-hypothesis" id="saveHypothesisBtn" disabled>Проверить гипотезу!</button>































































                        </div>































































                    </div>































































                </div>































































                        <div class="card-body" data-result-body>































































                            <p class="text-muted mb-0">Результаты появятся здесь после отправки гипотезы.</p>































































                        </div>































































                    </div>































































                </div>































































            </div>































































        </div>































































    </div>































































































































    <div class="modal fade" id="hypothesisPaymentModal" tabindex="-1" aria-labelledby="hypothesisPaymentModalLabel" aria-hidden="true">







        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">







            <div class="modal-content">







                <div class="modal-header">







                    <h5 class="modal-title" id="hypothesisPaymentModalLabel">Подтверждение запроса</h5>







                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>







                </div>







                <div class="modal-body">







                    <div class="text-center" data-modal-state="loader">







                        <div class="spinner-border text-primary mb-3" role="status" aria-hidden="true"></div>







                        <p class="mb-0 fw-semibold">Считаем стоимость вашего запроса</p>







                    </div>







                    <div class="text-center d-none" data-modal-state="result">







                        <p class="lead mb-3 fw-semibold">Для жюри бесплатно</p>







                        <button type="button" class="btn btn-primary w-100" id="confirmHypothesisPaymentBtn">Оплатить</button>







                    </div>







                </div>







            </div>







        </div>







    </div>















    <div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">































































        <div class="modal-dialog modal-lg modal-dialog-centered">































































            <div class="modal-content">































































                <div class="modal-header">































































                    <h5 class="modal-title" id="mapModalLabel">Карта для уточнения зоны</h5>































































                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>































































                </div>































































                <div class="modal-body p-0">































































                    <iframe































































                        title="Интерактивная карта"































































                        src="https://yandex.ru/map-widget/v1/-/CCUbxAlQ"































































                        style="border: 0; width: 100%; height: 420px;"































































                        allowfullscreen































































                        loading="lazy"































































                    ></iframe>































































                </div>































































                <div class="modal-footer">































































                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Закрыть</button>































































                </div>































































            </div>































































        </div>































































    </div>































































@endsection































































































































@push('scripts')































































    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>































































    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>































































    <script>































































        document.addEventListener('DOMContentLoaded', () => {































































            const dateRangeInput = document.getElementById('dateRange');































































            if (dateRangeInput) {































































                flatpickr(dateRangeInput, {































































                    mode: 'range',































































                    dateFormat: 'd.m.Y',































































                    locale: flatpickr.l10ns.ru,































































                });































































            }































































































































            const locationInput = document.getElementById('userLocation');































































            const detectLocationBtn = document.getElementById('detectLocationBtn');































































            const locationStatus = document.getElementById('locationStatus');































































































































            if (locationInput && detectLocationBtn && locationStatus) {































































                const setStatus = (message, isError = false) => {































































                    locationStatus.textContent = message;































































                    locationStatus.classList.toggle('text-danger', isError);































































                    locationStatus.classList.toggle('text-muted', !isError);































































                };































































































































                const populateLocation = (addressData) => {































































                    if (!addressData || !addressData.address) {































































                        return null;































































                    }































































































































                    const address = addressData.address;































































                    const city = address.city || address.town || address.village || address.hamlet || address.locality;































































                    const district = address.city_district || address.suburb || address.borough || address.neighbourhood || address.county;































































































































                    const parts = [];































































                    if (city) {































































                        parts.push(city);































































                    }































































                    if (district && district !== city) {































































                        parts.push(district);































































                    }































































































































                    if (parts.length === 0 && addressData.display_name) {































































                        const displayFirst = addressData.display_name.split(',').slice(0, 2).join(', ').trim();































































                        if (displayFirst) {































































                            parts.push(displayFirst);































































                        }































































                    }































































































































                    return parts.join(', ');































































                };































































































































                const reverseGeocode = async (lat, lon) => {































































                    const url = new URL('https://nominatim.openstreetmap.org/reverse');































































                    url.searchParams.set('format', 'jsonv2');































































                    url.searchParams.set('lat', lat);































































                    url.searchParams.set('lon', lon);































































                    url.searchParams.set('accept-language', 'ru');































































                    url.searchParams.set('zoom', '12');































































































































                    const response = await fetch(url.toString(), {































































                        headers: { 'Accept': 'application/json' },































































                    });































































































































                    if (!response.ok) {































































                        throw new Error('?? ????? ??????? ????, ??? ' + response.status);































































                    }































































































































                    return response.json();































































                };































































































































                const detectLocation = async () => {































































                    if (!('geolocation' in navigator)) {































































                        setStatus('???? ?? ?????????? ?????????.', true);































































                        return;































































                    }































































































































                    setStatus('Пробуем вас найти...');































































                    locationInput.placeholder = 'Здесь будет ваша геолокация';































































































































                    navigator.geolocation.getCurrentPosition(async (position) => {































































                        const { latitude, longitude } = position.coords;































































                        try {































































                            setStatus('Определяем геолокацию...');































































                            const data = await reverseGeocode(latitude, longitude);































































                            const locationText = populateLocation(data);































































                            if (locationText) {































































                                locationInput.value = locationText;































































                                setStatus('Опеределено: ' + locationText);































































                            } else {































































                                setStatus('Не удалось определить местоположение.', true);































































                            }































































                        } catch (error) {































































                            console.error(error);































































                            setStatus('?? ???????? ???????? ????. ?????? ??? ?.', true);































































                        }































































                    }, (error) => {































































                        console.error(error);































































                        setStatus('????????? ????????: ' + (error.message || '????????? ????'), true);































































                    }, {































































                        enableHighAccuracy: false,































































                        timeout: 10000,































































                        maximumAge: 300000,































































                    });































































                };































































































































                detectLocationBtn.addEventListener('click', detectLocation);































































                detectLocation();































































            }































































































































            const form = document.querySelector('.hypothesis-card');































































            const hypothesisInput = document.getElementById('hypothesis');































































































            const submitBtn = form ? form.querySelector('button[type="submit"]') : null;































































            const resultWrapper = document.getElementById('hypothesisResult');































































            const resultBody = document.querySelector('[data-result-body]');































































            const resultStatus = document.querySelector('[data-result-status]');































































            const resultFooter = document.querySelector('[data-result-footer]');































































            const resultHelper = document.querySelector('[data-result-helper]');































































            const saveHypothesisBtn = document.getElementById('saveHypothesisBtn');







            const paymentModalElement = document.getElementById('hypothesisPaymentModal');







            const paymentModalLoader = paymentModalElement?.querySelector('[data-modal-state="loader"]');







            const paymentModalResult = paymentModalElement?.querySelector('[data-modal-state="result"]');







            const paymentModalConfirmBtn = document.getElementById('confirmHypothesisPaymentBtn');







            const paymentModalInstance = paymentModalElement && typeof bootstrap !== 'undefined' && bootstrap?.Modal







                ? new bootstrap.Modal(paymentModalElement, { backdrop: 'static', keyboard: false })







                : null;







            let paymentModalTimerId = null;















            if (paymentModalElement) {







                paymentModalElement.addEventListener('hidden.bs.modal', () => {







                    if (paymentModalTimerId) {







                        window.clearTimeout(paymentModalTimerId);







                        paymentModalTimerId = null;







                    }







                    if (paymentModalLoader) {







                        paymentModalLoader.classList.remove('d-none');







                    }







                    if (paymentModalResult) {







                        paymentModalResult.classList.add('d-none');







                    }







                    if (paymentModalConfirmBtn && !saveHypothesisBtn?.disabled) {







                        paymentModalConfirmBtn.disabled = false;







                    }







                });







            }







































































            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');































































            const classificationApiBase = 'https://neiro.vsevolodrepit.ru/classify';































































            const storeEndpoint = '{{ route('hypothesis.store') }}';































































            const profileEndpoint = '{{ route('profile') }}';































































            const buildApiUrl = (text) => `${classificationApiBase}?top_k=2&text=${encodeURIComponent(text)}`;































































            let lastClassifierPayload = null;































































            const defaultCreateButtonHtml = saveHypothesisBtn ? saveHypothesisBtn.innerHTML : '';































































            const defaultHelperText = resultHelper ? resultHelper.textContent : '';































































            const statusLabels = {































































                in_progress: 'В процессе',































































                resolved: 'Решена',































































            };































































































































            if (!form || !hypothesisInput || !submitBtn || !resultWrapper || !resultBody) {































































                return;































































            }































































































































            const defaultButtonHtml = submitBtn.innerHTML;































































































































            const updateSubmitDisabled = () => {































































                submitBtn.disabled = hypothesisInput.value.trim().length === 0;































































            };































































































































            const setButtonLoading = (loading) => {































































                if (loading) {































































                    submitBtn.disabled = true;































































                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';































































                } else {































































                    submitBtn.innerHTML = defaultButtonHtml;































































                    updateSubmitDisabled();































































                }































































            };































































































































            const toggleHypothesisAction = (visible) => {































































                if (!resultFooter || !saveHypothesisBtn) {































































                    return;































































                }































































































































                resultFooter.hidden = !visible;































































































































                if (visible) {































































                    saveHypothesisBtn.disabled = false;































































                    if (defaultCreateButtonHtml) {































































                        saveHypothesisBtn.innerHTML = defaultCreateButtonHtml;































































                    }































































                    if (resultHelper && defaultHelperText) {































































                        resultHelper.className = 'text-muted small';































































                        resultHelper.textContent = defaultHelperText;































































                    }































































                } else {































































                    saveHypothesisBtn.disabled = true;































































                    if (defaultCreateButtonHtml) {































































                        saveHypothesisBtn.innerHTML = defaultCreateButtonHtml;































































                    }































































                    if (resultHelper && defaultHelperText) {































































                        resultHelper.className = 'text-muted small';































































                        resultHelper.textContent = defaultHelperText;































































                    }































































                }































































            };































































































































            const setHypothesisActionLoading = (loading) => {































































                if (!saveHypothesisBtn) {































































                    return;































































                }































































































































                if (loading) {































































                    saveHypothesisBtn.disabled = true;































































                    saveHypothesisBtn.innerHTML = '<span class=\"spinner-border spinner-border-sm me-2\" role=\"status\" aria-hidden=\"true\"></span>Проверяем...';































































                } else if (defaultCreateButtonHtml) {































































                    saveHypothesisBtn.innerHTML = defaultCreateButtonHtml;































































                }































































            };































































































































            const setHypothesisActionMessage = (message, variant = 'muted') => {































































                if (!resultHelper) {































































                    return;































































                }































































































































                const classMap = {































































                    muted: 'text-muted small',































































                    success: 'text-success small',































































                    danger: 'text-danger small',































































                    warning: 'text-warning small',































































                    info: 'text-info small',































































                };































































































































                resultHelper.className = classMap[variant] ?? classMap.muted;































































                resultHelper.textContent = message ?? '';































































            };































































































































            const escapeHtml = (value = '') => String(value)































































                .replace(/&/g, '&amp;')































































                .replace(/</g, '&lt;')































































                .replace(/>/g, '&gt;')































































                .replace(/"/g, '&quot;')































































                .replace(/'/g, '&#039;');































































































































            const updateBadge = (label, variant = 'secondary') => {































































                if (!resultStatus) {































































                    return;































































                }































































                const variants = {































































                    success: 'bg-success text-white',































































                    danger: 'bg-danger text-white',































































                    warning: 'bg-warning text-dark',































































                    info: 'bg-info text-white',































































                    secondary: 'bg-secondary text-white',































































                };































































                resultStatus.className = `badge ${variants[variant] ?? variants.secondary}`;































































                resultStatus.textContent = label;































































            };































































































































            const showNotice = (message, variant = 'info', labelOverride = null) => {































































                const labelMap = {































































                    danger: 'error',































































                    warning: 'warning',































































                    info: 'info',































































                    success: 'success',































































                };































































                toggleHypothesisAction(false);































































                lastClassifierPayload = null;































































                resultWrapper.hidden = false;































































                resultBody.innerHTML = `<div class="alert alert-${variant} mb-0">${escapeHtml(message)}</div>`;































































                updateBadge(labelOverride ?? labelMap[variant] ?? 'info', variant);































































            };































































































































            const renderClassifierResults = (payload) => {































































                resultWrapper.hidden = false;































































                toggleHypothesisAction(false);































































































































                if (!payload || typeof payload !== 'object') {































































                    updateBadge('danger', 'danger');































































                    resultBody.innerHTML = `<p class="text-danger mb-0">Сервис вернул неожиданный ответ.</p>`;































































                    lastClassifierPayload = null;































































                    toggleHypothesisAction(false);































































                    return;































































                }































































































































                const query = typeof payload.query === 'string' && payload.query.trim().length































































                    ? payload.query.trim()































































                    : hypothesisInput.value.trim();































































































































                const results = Array.isArray(payload.results) ? payload.results : [];































































































































                if (!results.length) {































































                    updateBadge('warning', 'warning');































































                    const rawNote = typeof payload.message === 'string' && payload.message.trim().length































































                        ? payload.message.trim()































































                        : 'Сервис не нашёл подходящих вариантов.';































































                    resultBody.innerHTML = `<p class="text-muted mb-0">${escapeHtml(rawNote)}</p>`;































































                    lastClassifierPayload = null;































































                    toggleHypothesisAction(false);































































                    return;































































                }































































































































                updateBadge('готово', 'success');































































                lastClassifierPayload = { query, results, raw: payload };































































                toggleHypothesisAction(true);































































































































                const infoNotice = typeof payload.message === 'string' && payload.message.trim().length































































                    ? `<p class="alert alert-primary mb-3">${escapeHtml(payload.message.trim())}</p>`































































                    : '';































































































































                const optionsHtml = results.map((item, index) => {































































                    const category = typeof item.category === 'string' && item.category.trim().length































































                        ? item.category.trim()































































                        : 'Без категории';































































                    const mcc = typeof item.mcc === 'string' && item.mcc.trim().length































































                        ? item.mcc.trim()































































                        : 'n/a';































































                    const scorePercent = typeof item.score === 'number'































































                        ? `${(item.score * 100).toFixed(1).replace(/\.0$/, '')}%`































































                        : null;































































































































                    const examples = (() => {































































                        if (Array.isArray(item.examples)) {































































                            return item.examples































































                                .flatMap((value) => String(value ?? '').split(','))































































                                .map((value) => value.trim())































































                                .filter(Boolean);































































                        }































































                        if (typeof item.examples === 'string') {































































                            return item.examples.split(',').map((value) => value.trim()).filter(Boolean);































































                        }































































                        return [];































































                    })();































































































































                    const examplesHtml = examples.length































































                        ? `<div class="text-muted small mt-2">Примеры: ${examples.map((example) => escapeHtml(example)).join(', ')}</div>`































































                        : '<div class="text-muted small mt-2 fst-italic">Примеры отсутствуют</div>';































































































































                    const scoreBadge = scorePercent































































                        ? `<span class="badge bg-light text-dark align-self-start">≈${escapeHtml(scorePercent)}</span>`































































                        : '';































































































































                    return `































































                        <label class="hypothesis-option d-flex gap-3 align-items-start">































































                            <input class="form-check-input mt-1" type="radio" name="hypothesisResultOption" value="${escapeHtml(mcc)}" ${index === 0 ? 'checked' : ''}>































































                            <div class="flex-grow-1">































































                                <div class="d-flex justify-content-between gap-2 flex-wrap">































































                                    <div>































































                                        <div class="fw-semibold">${escapeHtml(category)}</div>































































                                        <div class="text-muted small">MCC: ${escapeHtml(mcc)}</div>































































                                    </div>































































                                    ${scoreBadge}































































                                </div>































































                                ${examplesHtml}































































                            </div>































































                        </label>































































                    `;































































                }).join('');































































































































                const querySection = query.length































































                    ? `<p class="text-muted mb-3"><strong>Запрос:</strong> ${escapeHtml(query)}</p>`































































                    : '';































































































































                resultBody.innerHTML = `































































                    ${querySection}































































                    ${infoNotice}































































                    <div class="d-flex flex-column">































































                        ${optionsHtml}































































                    </div>































































                    <p class="text-muted small mt-3 mb-0">Выберите один вариант и нажмите "Проверить гипотезу!".</p>































































                `;































































































































                const optionInputs = Array.from(resultBody.querySelectorAll('input[name="hypothesisResultOption"]'));































































                const syncActiveState = () => {































































                    optionInputs.forEach((radio) => {































































                        const wrapper = radio.closest('.hypothesis-option');































































                        if (wrapper) {































































                            wrapper.classList.toggle('active', radio.checked);































































                        }































































                    });































































                };































































                optionInputs.forEach((radio) => {































































                    radio.addEventListener('change', syncActiveState);































































                });































































                syncActiveState();































































            };































































































































            const buildHypothesisPayload = () => {































































                const hypothesisValue = hypothesisInput.value.trim();































































                if (!hypothesisValue.length) {































































                    throw new Error('Заполните поле гипотезы.');































































                }































































































































                const selectedOption = resultBody.querySelector('input[name="hypothesisResultOption"]:checked');































































                if (!selectedOption) {































































                    throw new Error('Выберите вариант MCC.');































































                }































































































































                const locationValue = typeof locationInput?.value === 'string' ? locationInput.value.trim() : '';































































































































                const dateRangeValue = typeof dateRangeInput?.value === 'string' ? dateRangeInput.value.trim() : '';































































                const mccValue = selectedOption.value.trim();































































































































                return {































































                    user_location: locationValue.length ? locationValue : null,































































































                    date_range: dateRangeValue.length ? dateRangeValue : null,































































                    hypothesis: hypothesisValue,































































                    mcc_code: mccValue,































































                };































































            };































































































































            const handleCreateHypothesis = async () => {































































                if (!saveHypothesisBtn) {































































                    return;































































                }































































































































                try {































































                    if (!lastClassifierPayload) {































































                        setHypothesisActionMessage('Сначала получите варианты МСС.', 'warning');































































                        return;































































                    }































































































































                    const payload = buildHypothesisPayload();































































































































                    setHypothesisActionMessage('Проверяем гипотезу...', 'info');































































                    setHypothesisActionLoading(true);































































































































                    const response = await fetch(storeEndpoint, {































































                        method: 'POST',































































                        headers: {































































                            'Content-Type': 'application/json',































































                            'Accept': 'application/json',































































                            ...(csrfToken ? { 'X-CSRF-TOKEN': csrfToken } : {}),































































                        },































































                        credentials: 'same-origin',































































                        body: JSON.stringify(payload),































































                    });































































































































                    const contentType = (response.headers.get('content-type') ?? '').toLowerCase();































































                    let data = null;































































































































                    if (contentType.includes('application/json')) {































































                        data = await response.json();































































                    } else if (!response.ok) {































































                        const preview = (await response.text()).slice(0, 160);































































                        throw new Error(`Не удалось проверить гипотезу: ${preview}`);































































                    }































































































































                    if (response.status === 422 && data) {































































                        const messages = Object.values(data.errors ?? {}).flat();































































                        throw new Error(messages[0] ?? 'Исправьте данные и попробуйте ещё раз.');































































                    }































































































































                    if (!response.ok) {































































                        const message = data && typeof data === 'object' && 'message' in data































































                            ? data.message































































                            : `Ошибка ${response.status}`;































































                        throw new Error(String(message));































































                    }































































































































                    const serverStatus = data?.data?.status ?? 'in_progress';































































                    const humanStatus = statusLabels[serverStatus] ?? statusLabels.in_progress;































































































































                    setHypothesisActionMessage(`Гипотеза сохранена. Статус: ${humanStatus}.`, 'success');































































                    saveHypothesisBtn.disabled = true;































































                    window.location.href = profileEndpoint;































































                } catch (error) {































































                    console.error(error);































































                    const message = error instanceof Error ? error.message : 'Не удалось проверить гипотезу.';































































                    setHypothesisActionMessage(message, 'danger');































































                    saveHypothesisBtn.disabled = false;































































                } finally {































































                    setHypothesisActionLoading(false);































































                }































































            };































































































































            const openPaymentModal = () => {



                if (!paymentModalInstance) {



                    handleCreateHypothesis();



                    return;



                }







                if (paymentModalLoader) {



                    paymentModalLoader.classList.remove('d-none');



                }



                if (paymentModalResult) {



                    paymentModalResult.classList.add('d-none');



                }



                if (paymentModalTimerId) {



                    window.clearTimeout(paymentModalTimerId);



                }







                paymentModalInstance.show();







                paymentModalTimerId = window.setTimeout(() => {



                    if (paymentModalLoader) {



                        paymentModalLoader.classList.add('d-none');



                    }



                    if (paymentModalResult) {



                        paymentModalResult.classList.remove('d-none');
                        if (paymentModalConfirmBtn) {
                            paymentModalConfirmBtn.focus();
                        }



                    }



                        }, 2000);



            };










            if (paymentModalConfirmBtn) {
                paymentModalConfirmBtn.addEventListener('click', async () => {
                    if (paymentModalConfirmBtn.disabled) {
                        return;
                    }

                    paymentModalConfirmBtn.disabled = true;

                    if (paymentModalInstance) {
                        paymentModalInstance.hide();
                    }

                    if (saveHypothesisBtn) {
                        saveHypothesisBtn.disabled = true;
                    }

                    await handleCreateHypothesis();

                    if (saveHypothesisBtn && !saveHypothesisBtn.disabled) {
                        paymentModalConfirmBtn.disabled = false;
                    }
                });
            }

            if (saveHypothesisBtn) {
                saveHypothesisBtn.addEventListener('click', () => {
                    if (saveHypothesisBtn.disabled) {
                        return;
                    }

                    if (!lastClassifierPayload) {
                        setHypothesisActionMessage('������� �������� �������� ���.', 'warning');
                        return;
                    }

                    try {
                        buildHypothesisPayload();
                    } catch (error) {
                        console.error(error);
                        const fallbackMessage = error instanceof Error ? error.message : 'Не удалось сформировать запрос.';
                        setHypothesisActionMessage(fallbackMessage, 'danger');
                        return;
                    }

                    openPaymentModal();
                });
            }

            toggleHypothesisAction(false);































































            updateSubmitDisabled();































































            hypothesisInput.addEventListener('input', updateSubmitDisabled);































































































































            form.addEventListener('submit', async (event) => {































































                event.preventDefault();































































                if (hypothesisInput.value.trim().length === 0) {































































                    updateSubmitDisabled();































































                    return;































































                }































































































































                showNotice('Запрашиваем варианты МСС...', 'info', 'loading');































































                setButtonLoading(true);































































































































                try {































































                    const query = hypothesisInput.value.trim();































































                    const requestUrl = buildApiUrl(query);































































































































                    const response = await fetch(requestUrl, {































































                        method: 'GET',































































                        headers: {































































                            'Accept': 'application/json',































































                        },































































                        cache: 'no-store',































































                    });































































































































                    const contentType = (response.headers.get('content-type') ?? '').toLowerCase();































































                    if (!contentType.includes('application/json')) {































































                        const preview = (await response.text()).slice(0, 200);































































                        throw new Error(`Сервис вернул не-JSON ответ: ${preview}`);































































                    }































































































































                    const data = await response.json();































































































































                    if (!response.ok) {































































                        const message = typeof data === 'object' && data !== null && 'message' in data































































                            ? data.message































































                            : `Request failed with status ${response.status}`;































































                        throw new Error(String(message));































































                    }































































































































                    renderClassifierResults(data);































































                } catch (error) {































































                    console.error(error);































































                    const message = error instanceof Error ? error.message : 'Unexpected error.';































































                    showNotice(message, 'danger');































































                } finally {































































                    setButtonLoading(false);































































                }































































































































            });































































        });































































    </script>































































@endpush































































































































































































































































